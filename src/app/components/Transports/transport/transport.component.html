<div class="transport-container">
  <div class="form-card">
    <div class="card-header">
      <h2 class="form-title">
        <i class="fas fa-truck"></i> Create Transport Entry
      </h2>
    </div>
    
    <div class="form-content">
      <app-loader [show]="loading"></app-loader>
      
      <form [formGroup]="transportForm" (ngSubmit)="onSubmit()" class="transport-form" [class.loading]="loading">
        <!-- Customer Selection -->
        <div class="form-group customer-section">
          <label for="customerId">
            <i class="fas fa-user"></i> Select Customer <span class="required">*</span>
          </label>
          <div class="customer-select-group">
            <app-searchable-select
              formControlName="customerId"
              [options]="customers"
              labelKey="name"
              valueKey="id"
              [placeholder]="'Select Customer'"
              [defaultOption]="{ label: 'Select Customer', value: '' }"
              [searchPlaceholder]="'Search customers...'"
              [class.is-invalid]="isFieldInvalid(transportForm.get('customerId'))"
            ></app-searchable-select>
            <button 
              type="button" 
              class="btn-icon refresh" 
              (click)="refreshCustomers()" 
              [disabled]="isLoadingCustomers"
              title="Refresh Customers"
            >
              <i class="fas" [ngClass]="isLoadingCustomers ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
            </button>
          </div>
          <div class="invalid-feedback" *ngIf="isFieldInvalid(transportForm.get('customerId'))">
            Please select a customer
          </div>
        </div>

        <!-- Bags Section -->
        <div class="bags-section" formArrayName="bags">
          <div class="bags-header">
            <h3>Bags</h3>
            <button 
              type="button" 
              class="btn btn-primary add-bag-btn" 
              (click)="addBag()"
              [disabled]="loading"
            >
              <i class="fas fa-plus"></i> Add Bag
            </button>
          </div>

          <div class="bags-list" *ngIf="bags.length > 0">
            <div class="bag-card" *ngFor="let bag of bags.controls; let bagIndex = index" [formGroupName]="bagIndex">
              <div class="bag-header">
                <h4>Bag #{{ bagIndex + 1 }}</h4>
                <button 
                  type="button" 
                  class="btn btn-danger remove-bag-btn" 
                  (click)="onDeleteBag(bagIndex)"
                  [disabled]="bags.length === 1"
                >
                  <i class="fas fa-trash"></i>
                </button>
              </div>

              <div class="bag-weight">
                <div class="form-group">
                  <label>
                    <i class="fas fa-weight"></i> Weight (kg) <span class="required">*</span>
                  </label>
                  <input 
                    type="number" 
                    formControlName="weight" 
                    class="form-control"
                    [class.is-invalid]="isFieldInvalid(bag.get('weight'))"
                    min="0.01"
                    step="0.01"
                  >
                  <div class="invalid-feedback" *ngIf="isFieldInvalid(bag.get('weight'))">
                    {{ getCustomErrorMessage(bag.get('weight'), 'weight') }}
                  </div>
                </div>
              </div>

              <div class="items-section" formArrayName="items">
                <div class="items-header">
                  <h5>Items</h5>
                  <button 
                    type="button" 
                    class="btn btn-secondary add-item-btn" 
                    (click)="addItem(bagIndex)"
                  >
                    <i class="fas fa-plus"></i> Add Item
                  </button>
                </div>

                <div class="items-list">
                  <div 
                    class="item-row" 
                    *ngFor="let item of getBagItems(bagIndex).controls; let itemIndex = index" 
                    [formGroupName]="itemIndex"
                  >
                    <div class="form-group">
                      <label>Product <span class="required">*</span></label>
                      <div class="product-select-group">
                        <app-searchable-select
                          formControlName="productId"
                          [options]="products"
                          labelKey="name"
                          valueKey="id"
                          [placeholder]="'Select Product'"
                          [defaultOption]="{ label: 'Select Product', value: '' }"
                          [searchPlaceholder]="'Search products...'"
                          [class.is-invalid]="isFieldInvalid(item.get('productId'))"
                        ></app-searchable-select>
                        <button 
                          type="button" 
                          class="btn-icon refresh" 
                          (click)="refreshProducts()" 
                          [disabled]="isLoadingProducts"
                          title="Refresh Products"
                        >
                          <i class="fas" [ngClass]="isLoadingProducts ? 'fa-spinner fa-spin' : 'fa-sync-alt'"></i>
                        </button>
                      </div>
                    </div>

                    <div class="form-group">
                      <label>Quantity <span class="required">*</span></label>
                      <input 
                        type="number" 
                        formControlName="quantity" 
                        class="form-control"
                        [class.is-invalid]="isFieldInvalid(item.get('quantity'))"
                        min="1"
                      >
                      <div class="invalid-feedback" *ngIf="isFieldInvalid(item.get('quantity'))">
                        {{ getCustomErrorMessage(item.get('quantity'), 'quantity') }}
                      </div>
                    </div>

                    <div class="form-group">
                      <label>Remarks</label>
                      <input 
                        type="text" 
                        formControlName="remarks" 
                        class="form-control"
                        placeholder="Optional remarks"
                      >
                    </div>

                    <button 
                      type="button" 
                      class="btn btn-danger remove-item-btn" 
                      (click)="onDeleteItem(bagIndex, itemIndex)"
                      [disabled]="getBagItems(bagIndex).length === 1"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-secondary"
            (click)="resetForm()"
            [disabled]="loading"
          >
            <i class="fas fa-undo"></i> Reset
          </button>
          <button 
            type="submit" 
            class="btn btn-primary"
            [disabled]="transportForm.invalid || loading"
          >
            <i class="fas" [ngClass]="loading ? 'fa-spinner fa-spin' : 'fa-save'"></i>
            {{ loading ? 'Saving...' : 'Save Transport' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<app-confirm-modal
  [show]="showDeleteBagModal"
  title="Delete Bag"
  message="Are you sure you want to delete this bag and all its items?"
  (confirm)="confirmDeleteBag()"
  (cancel)="cancelDelete()"
></app-confirm-modal>

<app-confirm-modal
  [show]="showDeleteItemModal"
  title="Delete Item"
  message="Are you sure you want to delete this item?"
  (confirm)="confirmDeleteItem()"
  (cancel)="cancelDelete()"
></app-confirm-modal>
